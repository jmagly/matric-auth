<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MATRIC Authentication Test Suite</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .auth-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        .auth-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .auth-card h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover {
            background: #5a67d8;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-size: 14px;
            word-break: break-word;
        }
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .result pre {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.05);
            border-radius: 4px;
            overflow-x: auto;
        }
        .links {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        .links h3 {
            color: #333;
            margin-bottom: 10px;
        }
        .links a {
            display: block;
            color: #667eea;
            text-decoration: none;
            padding: 5px 0;
        }
        .links a:hover {
            text-decoration: underline;
        }
        .token-display {
            margin-top: 10px;
            padding: 10px;
            background: #f1f3f5;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            overflow-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê MATRIC Authentication Test Suite</h1>
        
        <div class="auth-grid">
            <!-- Password Grant Flow -->
            <div class="auth-card">
                <h2>Direct Password Login</h2>
                <form id="passwordForm">
                    <div class="form-group">
                        <label>Username/Email:</label>
                        <select id="passwordUser">
                            <option value="admin@matric.local">admin@matric.local</option>
                            <option value="developer@matric.local">developer@matric.local</option>
                            <option value="viewer@matric.local">viewer@matric.local</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Password:</label>
                        <input type="password" id="passwordPwd" value="admin123">
                    </div>
                    <button type="submit">Login with Password</button>
                </form>
                <div id="passwordResult"></div>
            </div>

            <!-- Authorization Code Flow -->
            <div class="auth-card">
                <h2>OAuth2 Authorization Code</h2>
                <p style="margin-bottom: 15px; color: #666;">
                    Redirects to Keycloak login page, then back with auth code
                </p>
                <button onclick="startAuthCodeFlow()">Start OAuth2 Flow</button>
                <div id="authCodeResult"></div>
            </div>

            <!-- Client Credentials -->
            <div class="auth-card">
                <h2>Service Account (M2M)</h2>
                <p style="margin-bottom: 15px; color: #666;">
                    Machine-to-machine authentication using client credentials
                </p>
                <button onclick="testClientCredentials()">Test Service Account</button>
                <div id="clientCredResult"></div>
            </div>

            <!-- Token Introspection -->
            <div class="auth-card">
                <h2>Token Validation</h2>
                <div class="form-group">
                    <label>Access Token:</label>
                    <textarea id="tokenToValidate" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: monospace; font-size: 12px;" placeholder="Paste an access token here to validate"></textarea>
                </div>
                <button onclick="validateToken()">Validate Token</button>
                <div id="validateResult"></div>
            </div>

            <!-- User Info -->
            <div class="auth-card">
                <h2>User Profile</h2>
                <p style="margin-bottom: 15px; color: #666;">
                    Get user information from access token
                </p>
                <button onclick="getUserInfo()" id="userInfoBtn" disabled>Login First</button>
                <div id="userInfoResult"></div>
            </div>

            <!-- Refresh Token -->
            <div class="auth-card">
                <h2>Token Refresh</h2>
                <p style="margin-bottom: 15px; color: #666;">
                    Use refresh token to get new access token
                </p>
                <button onclick="refreshToken()" id="refreshBtn" disabled>Login First</button>
                <div id="refreshResult"></div>
            </div>
        </div>

        <!-- Quick Links -->
        <div class="auth-card" style="margin-top: 30px;">
            <h2>üîó Keycloak Management Links</h2>
            <div class="links">
                <h3>User Self-Service:</h3>
                <a href="http://localhost:8081/realms/matric-dev/account" target="_blank">
                    üë§ Account Management Console - Manage your profile, password, sessions
                </a>
                <a href="http://localhost:8081/realms/matric-dev/login-actions/registration?client_id=matric-web&tab_id=test" target="_blank">
                    üìù User Registration - Sign up for new account
                </a>
                <a href="http://localhost:8081/realms/matric-dev/login-actions/reset-credentials?client_id=matric-web&tab_id=test" target="_blank">
                    üîë Password Reset - Forgot password flow
                </a>
                
                <h3 style="margin-top: 15px;">Admin Links:</h3>
                <a href="http://localhost:8081/admin/master/console/#/matric-dev/users" target="_blank">
                    ‚öôÔ∏è Admin Console - Users Management
                </a>
                <a href="http://localhost:8081/admin/master/console/#/matric-dev/clients" target="_blank">
                    üîß Admin Console - Client Configuration
                </a>
                <a href="http://localhost:8081/admin/master/console/#/matric-dev/realm-settings" target="_blank">
                    üèõÔ∏è Admin Console - Realm Settings
                </a>
                
                <h3 style="margin-top: 15px;">OpenID Connect Discovery:</h3>
                <a href="http://localhost:8081/realms/matric-dev/.well-known/openid-configuration" target="_blank">
                    üìã OpenID Configuration
                </a>
                <a href="http://localhost:8081/realms/matric-dev/protocol/openid-connect/certs" target="_blank">
                    üîê JWKS (Public Keys)
                </a>
            </div>
        </div>
    </div>

    <script>
        const KEYCLOAK_URL = 'http://localhost:8081';
        const REALM = 'matric-dev';
        const CLIENT_ID = 'matric-web';
        
        let currentTokens = null;

        // Password Grant Flow
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('passwordUser').value;
            const password = document.getElementById('passwordPwd').value;
            
            // Update password based on user selection
            const passwords = {
                'admin@matric.local': 'admin123',
                'developer@matric.local': 'dev123',
                'viewer@matric.local': 'view123'
            };
            document.getElementById('passwordPwd').value = passwords[username];
            
            try {
                const response = await fetch(`${KEYCLOAK_URL}/realms/${REALM}/protocol/openid-connect/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        grant_type: 'password',
                        client_id: CLIENT_ID,
                        username: username,
                        password: passwords[username],
                        scope: 'openid profile email'
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    currentTokens = data;
                    document.getElementById('userInfoBtn').disabled = false;
                    document.getElementById('refreshBtn').disabled = false;
                    
                    // Decode JWT to show claims
                    const claims = JSON.parse(atob(data.access_token.split('.')[1]));
                    
                    document.getElementById('passwordResult').innerHTML = `
                        <div class="result success">
                            <strong>‚úÖ Login Successful!</strong>
                            <div class="token-display">
                                <strong>User:</strong> ${claims.preferred_username || claims.email}<br>
                                <strong>Roles:</strong> ${JSON.stringify(claims.realm_access?.roles || [])}<br>
                                <strong>Token Type:</strong> ${data.token_type}<br>
                                <strong>Expires In:</strong> ${data.expires_in} seconds<br>
                                <strong>Scope:</strong> ${data.scope}
                            </div>
                            <details style="margin-top: 10px;">
                                <summary style="cursor: pointer; color: #667eea;">View Full Token Response</summary>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    throw new Error(data.error_description || data.error || 'Login failed');
                }
            } catch (error) {
                document.getElementById('passwordResult').innerHTML = `
                    <div class="result error">
                        <strong>‚ùå Error:</strong> ${error.message}
                    </div>
                `;
            }
        });

        // Authorization Code Flow
        function startAuthCodeFlow() {
            const redirectUri = encodeURIComponent(window.location.origin + window.location.pathname);
            const state = Math.random().toString(36).substring(7);
            const authUrl = `${KEYCLOAK_URL}/realms/${REALM}/protocol/openid-connect/auth?` +
                `client_id=${CLIENT_ID}&` +
                `redirect_uri=${redirectUri}&` +
                `response_type=code&` +
                `scope=openid profile email&` +
                `state=${state}`;
            
            window.location.href = authUrl;
        }

        // Check for auth code in URL
        window.addEventListener('load', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            
            if (code) {
                try {
                    const response = await fetch(`${KEYCLOAK_URL}/realms/${REALM}/protocol/openid-connect/token`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            grant_type: 'authorization_code',
                            client_id: CLIENT_ID,
                            code: code,
                            redirect_uri: window.location.origin + window.location.pathname
                        })
                    });

                    const data = await response.json();
                    if (response.ok) {
                        currentTokens = data;
                        document.getElementById('userInfoBtn').disabled = false;
                        document.getElementById('refreshBtn').disabled = false;
                        
                        document.getElementById('authCodeResult').innerHTML = `
                            <div class="result success">
                                <strong>‚úÖ OAuth2 Flow Complete!</strong>
                                <div class="token-display">
                                    <strong>Access Token Received</strong><br>
                                    <strong>Refresh Token:</strong> ${data.refresh_token ? 'Yes' : 'No'}<br>
                                    <strong>ID Token:</strong> ${data.id_token ? 'Yes' : 'No'}
                                </div>
                            </div>
                        `;
                    }
                } catch (error) {
                    document.getElementById('authCodeResult').innerHTML = `
                        <div class="result error">
                            <strong>‚ùå Error:</strong> ${error.message}
                        </div>
                    `;
                }
                
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });

        // Client Credentials Flow
        async function testClientCredentials() {
            try {
                const response = await fetch(`${KEYCLOAK_URL}/realms/${REALM}/protocol/openid-connect/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        grant_type: 'client_credentials',
                        client_id: 'matric-service',
                        client_secret: 'matric-service-secret',
                        scope: 'openid'
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    const claims = JSON.parse(atob(data.access_token.split('.')[1]));
                    document.getElementById('clientCredResult').innerHTML = `
                        <div class="result success">
                            <strong>‚úÖ Service Account Active!</strong>
                            <div class="token-display">
                                <strong>Client ID:</strong> ${claims.azp}<br>
                                <strong>Token Type:</strong> Bearer<br>
                                <strong>Expires:</strong> ${new Date(claims.exp * 1000).toLocaleString()}
                            </div>
                        </div>
                    `;
                } else {
                    throw new Error(data.error_description || data.error || 'Authentication failed');
                }
            } catch (error) {
                document.getElementById('clientCredResult').innerHTML = `
                    <div class="result error">
                        <strong>‚ùå Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // Token Validation
        async function validateToken() {
            const token = document.getElementById('tokenToValidate').value.trim();
            if (!token) {
                document.getElementById('validateResult').innerHTML = `
                    <div class="result error">
                        <strong>‚ùå Error:</strong> Please enter a token
                    </div>
                `;
                return;
            }

            try {
                // Decode JWT locally
                const parts = token.split('.');
                if (parts.length !== 3) {
                    throw new Error('Invalid JWT format');
                }
                
                const header = JSON.parse(atob(parts[0]));
                const payload = JSON.parse(atob(parts[1]));
                
                const now = Math.floor(Date.now() / 1000);
                const isExpired = payload.exp && payload.exp < now;
                
                document.getElementById('validateResult').innerHTML = `
                    <div class="result ${isExpired ? 'error' : 'success'}">
                        <strong>${isExpired ? '‚ùå Token Expired' : '‚úÖ Token Valid'}</strong>
                        <div class="token-display">
                            <strong>Subject:</strong> ${payload.sub}<br>
                            <strong>Issuer:</strong> ${payload.iss}<br>
                            <strong>Audience:</strong> ${payload.aud}<br>
                            <strong>Expires:</strong> ${new Date(payload.exp * 1000).toLocaleString()}<br>
                            <strong>Issued:</strong> ${new Date(payload.iat * 1000).toLocaleString()}
                        </div>
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: #667eea;">View Full Claims</summary>
                            <pre>${JSON.stringify(payload, null, 2)}</pre>
                        </details>
                    </div>
                `;
            } catch (error) {
                document.getElementById('validateResult').innerHTML = `
                    <div class="result error">
                        <strong>‚ùå Invalid Token:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // Get User Info
        async function getUserInfo() {
            if (!currentTokens) {
                document.getElementById('userInfoResult').innerHTML = `
                    <div class="result error">
                        <strong>‚ùå Error:</strong> Please login first
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch(`${KEYCLOAK_URL}/realms/${REALM}/protocol/openid-connect/userinfo`, {
                    headers: {
                        'Authorization': `Bearer ${currentTokens.access_token}`
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('userInfoResult').innerHTML = `
                        <div class="result success">
                            <strong>‚úÖ User Profile:</strong>
                            <div class="token-display">
                                <strong>Username:</strong> ${data.preferred_username}<br>
                                <strong>Email:</strong> ${data.email}<br>
                                <strong>Email Verified:</strong> ${data.email_verified}<br>
                                <strong>Name:</strong> ${data.name || 'Not set'}<br>
                                <strong>Subject:</strong> ${data.sub}
                            </div>
                            <details style="margin-top: 10px;">
                                <summary style="cursor: pointer; color: #667eea;">View Full Profile</summary>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    throw new Error('Failed to get user info');
                }
            } catch (error) {
                document.getElementById('userInfoResult').innerHTML = `
                    <div class="result error">
                        <strong>‚ùå Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // Refresh Token
        async function refreshToken() {
            if (!currentTokens || !currentTokens.refresh_token) {
                document.getElementById('refreshResult').innerHTML = `
                    <div class="result error">
                        <strong>‚ùå Error:</strong> No refresh token available
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch(`${KEYCLOAK_URL}/realms/${REALM}/protocol/openid-connect/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        grant_type: 'refresh_token',
                        client_id: CLIENT_ID,
                        refresh_token: currentTokens.refresh_token
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    currentTokens = data;
                    document.getElementById('refreshResult').innerHTML = `
                        <div class="result success">
                            <strong>‚úÖ Token Refreshed!</strong>
                            <div class="token-display">
                                <strong>New Access Token:</strong> Received<br>
                                <strong>New Refresh Token:</strong> ${data.refresh_token ? 'Yes' : 'No'}<br>
                                <strong>Expires In:</strong> ${data.expires_in} seconds
                            </div>
                        </div>
                    `;
                } else {
                    throw new Error(data.error_description || 'Refresh failed');
                }
            } catch (error) {
                document.getElementById('refreshResult').innerHTML = `
                    <div class="result error">
                        <strong>‚ùå Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // Update password when user selection changes
        document.getElementById('passwordUser').addEventListener('change', (e) => {
            const passwords = {
                'admin@matric.local': 'admin123',
                'developer@matric.local': 'dev123',
                'viewer@matric.local': 'view123'
            };
            document.getElementById('passwordPwd').value = passwords[e.target.value];
        });
    </script>
</body>
</html>